<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIGITAL LEARNING RESOURCE CENTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, query, orderBy, limit, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // This is important for debugging Firestore!
        // setLogLevel('Debug'); // Uncomment this line if you need debug logs

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;
        // Global storage for the latest messages
        window.chatMessages = [];

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Handle Authentication
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    // Start listening to chat history once we have a user ID
                    setupChatListener();
                } else {
                    // Sign in anonymously if no token is available or user is logged out
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Sign-in failed:", error);
                    }
                }
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `User ID: ${userId || 'Loading...'}`;
            });
        }

        // Global function to handle chat listening
        window.setupChatListener = function() {
            if (!db || !userId) return;

            const chatCollectionPath = `/artifacts/${appId}/users/${userId}/magic_dogs_chat`;
            const q = query(collection(db, chatCollectionPath), orderBy("timestamp", "asc"));

            onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push(doc.data());
                });
                window.chatMessages = messages; // Update the global message list
                window.renderChatHistory(messages); // Call the window function to update the UI
            }, (error) => {
                console.error("Error listening to chat history:", error);
            });
        }

        // Global function to save a message
        window.saveMessage = async function(role, text) {
            if (!db || !userId) {
                console.error("Firestore not ready or no user ID.");
                return;
            }

            const chatCollectionPath = `/artifacts/${appId}/users/${userId}/magic_dogs_chat`;
            
            // Create a new document with a unique ID
            await setDoc(doc(collection(db, chatCollectionPath)), {
                role: role,
                text: text,
                timestamp: serverTimestamp() // Use server timestamp for ordering
            });
        }
        
        // Expose DB for direct use in the send handler
        window.db = db;
        window.getUserId = () => userId;
        window.getAppId = () => appId;
    </script>

    <style>
        /* Removing permanent marker font for professional look */
        /* @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');
        .kid-font {
            font-family: 'Permanent Marker', cursive, 'Comic Sans MS', sans-serif;
            text-shadow: 2px 2px 0 #000;
        } */
        
        /* Using system font stack (Tailwind default) for professional look */

        .chat-bubble-user {
            /* Clean, light blue for professional contrast */
            @apply bg-blue-100 text-gray-800 self-end font-normal;
            border-radius: 18px 18px 4px 18px; 
        }

        .chat-bubble-ai {
            /* Deep indigo/purple for AI, text shadow removed */
            @apply bg-indigo-500 text-white self-start font-normal;
            border-radius: 18px 18px 18px 4px; 
            text-shadow: none; 
        }
        
        .chat-container {
            /* Clean, subtle border and white background */
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #E5E7EB; /* Light gray border */
            background-color: #FFFFFF; 
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8 text-gray-800 font-sans">
    
    <header class="text-center mb-10 p-6 bg-indigo-900 shadow-md border-b-4 border-teal-400">
        <h1 class="text-4xl sm:text-6xl text-white tracking-wide leading-none font-bold">
            DIGITAL LEARNING RESOURCE CENTER
        </h1>
        <p class="text-lg sm:text-xl text-indigo-200 mt-1 font-light">
            Curated Educational Content and Interactive Support
        </p>
        
        <div id="user-id-display" class="text-xs text-indigo-300 mt-4 font-light">User ID: Loading user info...</div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-7xl mx-auto">
        
        <div class="lg:col-span-2 space-y-8">

            <section class="p-6 bg-white rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-3xl text-indigo-700 mb-4 text-center pb-2 border-b-2 border-teal-400 font-semibold">
                    Video Learning Modules
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-xl text-indigo-600 mb-2 font-medium">Dog Agility Training Basics</h3>
                        <p class="text-sm text-gray-600">Introduction to fundamental dog training techniques and safety protocols.</p>
                        <a href="https://www.youtube.com/watch?v=mRHj9ZFXhK4" target="_blank" class="block mt-3 text-center py-2 bg-teal-500 hover:bg-teal-600 rounded-md text-sm text-white font-semibold shadow-md transition duration-200">
                            VIEW MODULE
                        </a>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-200">
                        <h3 class="text-xl text-indigo-600 mb-2 font-medium">Animal Communication and Behavior</h3>
                        <p class="text-sm text-gray-600">An in-depth look at canine body language and non-verbal cues.</p>
                        <a href="https://www.youtube.com/watch?v=WSnnwIDgQyI" target="_blank" class="block mt-3 text-center py-2 bg-teal-500 hover:bg-teal-600 rounded-md text-sm text-white font-semibold shadow-md transition duration-200">
                            VIEW MODULE
                        </a>
                    </div>
                </div>
            </section>
            
            <section class="p-6 bg-white rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-3xl text-indigo-700 mb-4 text-center pb-2 border-b-2 border-teal-400 font-semibold">
                    Original Children's Music Collection
                </h2>
                <p class="text-center text-lg text-gray-600 mb-4 font-light">
                    A selection of professionally produced, age-appropriate audio tracks.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-300">
                        <h3 class="text-xl text-indigo-700 mb-2 font-medium">The Movement and Rhythm Track</h3>
                        <p class="text-sm text-gray-600">Focuses on gross motor skills and rhythmic learning.</p>
                        <audio controls class="w-full mt-3">
                            <source src="placeholder_song_1.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                        <a href="#" class="block mt-3 text-center py-2 bg-teal-500 hover:bg-teal-600 rounded-md text-sm text-white font-semibold shadow-md transition duration-200">
                            DOWNLOAD ASSET
                        </a>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow-md border border-gray-300">
                        <h3 class="text-xl text-indigo-700 mb-2 font-medium">Mindfulness and Sleep Aid</h3>
                        <p class="text-sm text-gray-600">A calming piece designed for quiet time and relaxation.</p>
                        <audio controls class="w-full mt-3">
                            <source src="placeholder_song_2.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                        <a href="#" class="block mt-3 text-center py-2 bg-teal-500 hover:bg-teal-600 rounded-md text-sm text-white font-semibold shadow-md transition duration-200">
                            DOWNLOAD ASSET
                        </a>
                    </div>
                </div>
            </section>

            <section class="p-6 bg-white rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-3xl text-indigo-700 mb-4 text-center pb-2 border-b-2 border-teal-400 font-semibold">
                    Educational & Interactive Games 
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <a href="https://www.abcya.com" target="_blank" class="block text-center p-4 bg-gray-50 rounded-lg shadow-sm hover:bg-gray-100 transition duration-300 border border-indigo-600">
                        <span class="text-2xl">üìö</span>
                        <p class="text-sm font-medium text-gray-800 mt-1">Foundational Literacy</p>
                    </a>
                    <a href="https://pbskids.org/games" target="_blank" class="block text-center p-4 bg-gray-50 rounded-lg shadow-sm hover:bg-gray-100 transition duration-300 border border-indigo-600">
                        <span class="text-2xl">üì∫</span>
                        <p class="text-sm font-medium text-gray-800 mt-1">Character-Based Math</p>
                    </a>
                    <a href="https://www.funbrain.com/" target="_blank" class="block text-center p-4 bg-gray-50 rounded-lg shadow-sm hover:bg-gray-100 transition duration-300 border border-indigo-600">
                        <span class="text-2xl">üß†</span>
                        <p class="text-sm font-medium text-gray-800 mt-1">Logic and Problem Solving</p>
                    </a>
                </div>
            </section>
            
            <section class="p-6 bg-gray-100 rounded-lg shadow-sm border-l-4 border-indigo-500">
                <h2 class="text-2xl text-indigo-700 mb-4 pb-2 border-b-2 border-indigo-300 font-semibold">
                    Holiday Safety Guidelines (Pet Focus)
                </h2>
                <ul class="text-base space-y-2 list-disc list-inside text-gray-700 px-4">
                    <li>üö´ **Toxic Foods:** Prevent consumption of chocolate, grapes, and xylitol, which are toxic to canines.</li>
                    <li>ü¶¥ **Bone Hazards:** Avoid feeding cooked bones; offer only veterinarian-approved dental chews and treats.</li>
                    <li>üè° **Managing Stress:** Provide a quiet, low-traffic retreat area for pets during high-volume social gatherings.</li>
                    <li>üéÑ **Decor Dangers:** Ensure all holiday ornaments (e.g., tinsel, sharp glass, wire) and toxic seasonal plants are secured and inaccessible.</li>
                </ul>
            </section>
        </div>

        <div class="lg:col-span-1">
            <section class="p-6 bg-white rounded-lg shadow-xl border border-gray-200">
                <h2 class="text-3xl text-indigo-700 mb-4 text-center font-bold">
                    Support Q&A Assistant
                </h2>
                <p class="text-sm text-center text-gray-600 mb-4 font-light">Ask any question related to site resources or content safety.</p>

                <div id="chat-log" class="chat-container flex flex-col space-y-3 p-4 rounded-lg mb-4">
                    </div>

                <div class="mb-4 flex flex-col space-y-2">
                    <button id="read-aloud-btn" 
                            class="p-3 bg-teal-500 text-white rounded-md shadow-md hover:bg-teal-600 transition duration-300 active:bg-teal-700 font-semibold text-base">
                        Read Last Message Aloud üîä
                    </button>
                    <div id="tts-loading" class="hidden text-center text-indigo-600">
                        <span class="animate-pulse">Synthesizing response audio... üó£Ô∏è</span>
                    </div>
                </div>

                <div id="loading-indicator" class="hidden text-center text-indigo-600 mb-4">
                    <span class="animate-pulse">Assistant is generating response... üß†</span>
                </div>

                <div class="flex space-x-2">
                    <input type="text" id="user-input" placeholder="Enter your query here..." 
                           class="flex-grow p-3 border border-gray-300 rounded-md focus:outline-none focus:border-indigo-500 text-sm">
                    <button id="send-btn" 
                            class="p-3 bg-indigo-600 text-white rounded-md shadow-md hover:bg-indigo-700 transition duration-300 active:bg-indigo-800 font-semibold text-sm">
                        Send
                    </button>
                </div>
            </section>
        </div>
    </main>
    
    <audio id="tts-audio" class="hidden"></audio>

    <script type="module">
        // --- CHATBOT CONSTANTS ---
        const API_KEY = ""; // API key will be provided by the runtime
        const CHAT_MODEL_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const TTS_MODEL_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        const CHATBOT_NAME = "Assistant";
        
        // Revised professional system prompt
        const SYSTEM_PROMPT = `You are the Support Assistant for a Digital Learning Resource Center. You are professional, concise, and helpful. Your primary goal is to provide accurate, factual information regarding the provided resources (videos, music, games) and safety guidelines. Speak in a formal, informative tone. Keep answers brief and focused.`;

        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const readAloudBtn = document.getElementById('read-aloud-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const ttsLoadingIndicator = document.getElementById('tts-loading');
        const ttsAudio = document.getElementById('tts-audio');

        // Function to render a single message bubble
        function appendMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('max-w-[80%]', 'p-3', 'rounded-xl', 'shadow-sm', 'text-sm');
            messageDiv.style.wordBreak = 'break-word';

            if (role === 'user') {
                messageDiv.classList.add('chat-bubble-user');
                messageDiv.textContent = text;
            } else {
                messageDiv.classList.add('chat-bubble-ai');
                messageDiv.textContent = `${CHATBOT_NAME}: ${text}`;
            }

            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        
        // Global function to render all messages from Firestore
        window.renderChatHistory = function(messages) {
            chatLog.innerHTML = ''; // Clear existing messages
            messages.forEach(msg => {
                appendMessage(msg.role, msg.text);
            });
            // Auto-scroll to the bottom after loading history
            chatLog.scrollTop = chatLog.scrollHeight;
        };
        
        // --- Gemini API Call with Exponential Backoff ---
        async function fetchWithBackoff(url, payload) {
            const maxRetries = 5;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Log to console if debugging needed, but suppress for user
                }
            }
        }

        // --- CHAT LOGIC ---
        async function fetchGeminiResponse(userQuery, history) {
            const contents = history.map(msg => ({ 
                role: msg.role === 'user' ? 'user' : 'model', 
                parts: [{ text: msg.text }] 
            }));
            
            contents.push({ role: 'user', parts: [{ text: userQuery }] });

            const payload = {
                contents: contents,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
                generationConfig: {
                    temperature: 0.2, /* Lower temperature for professional, consistent output */
                    maxOutputTokens: 150 
                }
            };
            
            const result = await fetchWithBackoff(CHAT_MODEL_URL, payload);

            const candidate = result.candidates?.[0];
            if (candidate && candidate.content?.parts?.[0]?.text) {
                return candidate.content.parts[0].text;
            }
            return "Error: Unable to process the request at this time. Please try again later.";
        }
        
        // --- Main Send Logic ---
        async function handleSend() {
            const query = userInput.value.trim();
            if (!query || !window.saveMessage || !window.db) return;

            // 1. Disable input and show loading
            userInput.disabled = true;
            sendBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                // 2. Save user message to Firestore
                await window.saveMessage('user', query);
                userInput.value = '';

                // 3. Get the AI response using the current history
                const aiText = await fetchGeminiResponse(query, window.chatMessages);

                // 4. Save AI response to Firestore
                await window.saveMessage('model', aiText);

            } catch (error) {
                console.error("Chat sending failed:", error);
            } finally {
                // 5. Re-enable input and hide loading
                userInput.disabled = false;
                sendBtn.disabled = false;
                loadingIndicator.classList.add('hidden');
                userInput.focus();
            }
        }
        
    
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM

            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);

    
            writeString(view, 0, 'RIFF'); // Chunk ID
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true); // Chunk Size
            writeString(view, 8, 'WAVE'); // Format

        
            writeString(view, 12, 'fmt '); // Sub-chunk 1 ID
            view.setUint32(16, 16, true); // Sub-chunk 1 Size (16 for PCM)
            view.setUint16(20, 1, true); // Audio Format (1 for PCM)
            view.setUint16(22, numChannels, true); // Num Channels
            view.setUint32(24, sampleRate, true); // Sample Rate
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); // Byte Rate
            view.setUint16(32, numChannels * bytesPerSample, true); // Block Align
            view.setUint16(34, 16, true); // Bits Per Sample (16-bit)

            writeString(view, 36, 'data'); // Sub-chunk 2 ID
            view.setUint32(40, pcm16.length * bytesPerSample, true); // Sub-chunk 2 Size

    
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

    
        async function handleReadAloud() {
            readAloudBtn.disabled = true;
            ttsLoadingIndicator.classList.remove('hidden');
            
        
            const lastAiMessage = window.chatMessages.slice().reverse().find(msg => msg.role === 'model');
            
            if (!lastAiMessage) {
                alert("The Assistant has not provided a response yet. Please submit a query first.");
                readAloudBtn.disabled = false;
                ttsLoadingIndicator.classList.add('hidden');
                return;
            }

            const textToSpeak = lastAiMessage.text;

            
            const payload = {
                contents: [{
                    parts: [{ text: textToSpeak }] /* Removed the 'puppy dog voice' instruction for professionalism */
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Sierra" } /* Using a professional voice */
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
            
                const result = await fetchWithBackoff(TTS_MODEL_URL, payload);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);

            
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    ttsAudio.src = audioUrl;
                    ttsAudio.play();
                } else {
                    alert("Audio synthesis failed: No valid audio data was received.");
                }

            } catch (error) {
                console.error("TTS Error:", error);
                alert("An error occurred during audio generation. Please check the console for details.");
            } finally {
                readAloudBtn.disabled = false;
                ttsLoadingIndicator.classList.add('hidden');
            }
        }

    
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSend();
            }
        });
        readAloudBtn.addEventListener('click', handleReadAloud);
        
        
        window.onload = function() {
            setTimeout(() => {
                
                if (window.chatMessages.length === 0) {
                    appendMessage('model', "Welcome. I am your Support Assistant. Please submit your inquiry regarding our learning resources or guidelines.");
                }
            }, 1500);
        }
    </script>
</body>
</html>
