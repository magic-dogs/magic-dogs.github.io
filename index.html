<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Dogs Adventure Hub</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Phosphor Icons for fun visuals -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.0.3/dist/assets/index.js"></script>
    
    <!-- Configure Tailwind for Inter font and magical, bright colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'magic-purple': '#8B5CF6', // Violet-500
                        'sparkle-pink': '#EC4899', // Pink-500
                        'leaf-green': '#10B981',   // Emerald-500
                        'sky-blue': '#3B82F6',     // Blue-500
                        'bg-light': '#F3F4F6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base styling */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 10vh;
            background-color: #F3F4F6;
            padding: 0;
            margin: 0;
        }

        /* Updated Magical Leaf Background Pattern (Big Leaves) */
        .leaf-bg {
            background-color: #e6ffe6; /* Very light green base */
            opacity: 1;
            /* Large, repeating leaf-like pattern (using big dots/radial gradients) */
            background-image: radial-gradient(rgba(16, 185, 129, 0.3) 8px, transparent 8px), /* Leaf-green with high opacity */
                              radial-gradient(rgba(16, 185, 129, 0.3) 8px, #e6ffe6 8px);
            background-size: 100px 100px; /* Big leaves/dots */
            background-position: 0 0, 50px 50px;
        }

        /* Card and Header Shadows */
        .card-shadow {
            box-shadow: 0 15px 20px -5px rgba(139, 92, 246, 0.2), 0 5px 5px -5px rgba(0, 0, 0, 0.04);
        }

        /* Game specific styling for canvas */
        #game-canvas {
            border: 4px solid #8B5CF6;
            border-radius: 12px;
            touch-action: none; /* Prevents mobile scrolling when interacting with canvas */
        }
        
        /* Camera/Video element styling */
        #camera-feed {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 4/3;
            border-radius: 1rem;
            object-fit: cover;
            margin: 0 auto;
            display: block;
            background-color: #4B5563; /* Gray-600 placeholder */
        }

        /* Chatbot message bubble styling */
        .ai-message {
            background-color: #E0F2F1; /* Teal-50 */
            border-top-left-radius: 0;
        }
        .user-message {
            background-color: #E0F7FA; /* Cyan-50 */
            border-bottom-right-radius: 0;
        }

        /* Scrollbar styling for chat */
        #chat-window::-webkit-scrollbar, #book-output::-webkit-scrollbar {
            width: 8px;
        }
        #chat-window::-webkit-scrollbar-thumb, #book-output::-webkit-scrollbar-thumb {
            background: #8B5CF6;
            border-radius: 10px;
        }
        
        /* Active button styling for navigation */
        .nav-button.active {
            box-shadow: 0 0 0 3px white, 0 0 0 6px #EC4899;
            background-color: #EC4899; /* sparkle-pink */
            color: white;
        }
    </style>
</head>
<body class="leaf-bg">

    <div id="app" class="flex flex-col min-h-screen">
        
        <!-- Header and Navigation -->
        <header class="bg-magic-purple p-4 shadow-lg sticky top-0 z-20">
            <h1 class="text-3xl font-extrabold text-white text-center mb-4">
                üêæ Magic Dogs Adventure üêæ
            </h1>
            
            <nav class="flex justify-center space-x-1 sm:space-x-4 flex-wrap">
                <button onclick="navigate('facts')" id="nav-facts" class="nav-button bg-magic-purple text-white border-2 border-white transition rounded-full py-2 px-3 sm:px-4 text-sm sm:text-base font-semibold active">
                    Facts
                </button>
                <button onclick="navigate('games')" id="nav-games" class="nav-button bg-magic-purple text-white border-2 border-white transition rounded-full py-2 px-3 sm:px-4 text-sm sm:text-base font-semibold">
                    Games
                </button>
                 <button onclick="navigate('search')" id="nav-search" class="nav-button bg-magic-purple text-white border-2 border-white transition rounded-full py-2 px-3 sm:px-4 text-sm sm:text-base font-semibold">
                    Search
                </button>
                 <button onclick="navigate('sms')" id="nav-sms" class="nav-button bg-magic-purple text-white border-2 border-white transition rounded-full py-2 px-3 sm:px-4 text-sm sm:text-base font-semibold">
                    SMS Draft
                </button>
                <button onclick="navigate('studio')" id="nav-studio" class="nav-button bg-magic-purple text-white border-2 border-white transition rounded-full py-2 px-3 sm:px-4 text-sm sm:text-base font-semibold">
                    Studio
                </button>
                <button onclick="navigate('chat')" id="nav-chat" class="nav-button bg-magic-purple text-white border-2 border-white transition rounded-full py-2 px-3 sm:px-4 text-sm sm:text-base font-semibold">
                    Assistant
                </button>
                <button onclick="navigate('videos')" id="nav-videos" class="nav-button bg-magic-purple text-white border-2 border-white transition rounded-full py-2 px-3 sm:px-4 text-sm sm:text-base font-semibold">
                    Videos
                </button>
            </nav>
        </header>

        <main class="flex-grow p-4 sm:p-6 flex justify-center items-start">
            <div class="w-full max-w-5xl">
                
                <!-- 1. FUN FACTS SECTION -->
                <section id="section-facts" class="page-section">
                    <div class="bg-white p-6 md:p-10 rounded-3xl card-shadow text-center">
                        <h2 class="text-3xl font-bold text-sky-blue mb-4">Discover Magic Dog Facts!</h2>
                        <p class="text-gray-600 mb-8">
                            Even the most magical dogs have secrets to share. Click the bone!
                        </p>

                        <!-- Fact Display Area -->
                        <div class="p-6 md:p-8 bg-sparkle-pink text-white rounded-2xl shadow-inner mb-8 min-h-[150px] flex items-center justify-center">
                            <p id="fact-display" class="text-xl md:text-2xl font-bold italic transition-opacity duration-300">
                                Tap the button to get your first fun fact!
                            </p>
                        </div>

                        <!-- Action Button -->
                        <button id="fact-button"
                            class="w-full sm:w-2/3 py-4 px-6 bg-leaf-green text-white font-extrabold text-xl rounded-full transition-all duration-200 transform hover:scale-[1.03] hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-leaf-green focus:ring-opacity-50 active:bg-green-600"
                            role="button"
                        >
                            New Dog Fact! <i class="ph ph-bone text-2xl ml-2"></i>
                        </button>
                    </div>
                </section>

                <!-- 2. GAMES SECTION -->
                <section id="section-games" class="page-section hidden">
                    
                    <!-- Row 1: Block World & Number Guess -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        
                        <!-- Game 1: Magic Block World -->
                        <div class="bg-white p-6 md:p-8 rounded-3xl card-shadow text-center">
                            <h2 class="text-2xl font-bold text-sky-blue mb-4">Game 1: Magic Block World</h2>
                            <p class="text-gray-600 mb-4 text-sm">
                                **Click/Tap** to **break** a block. Click the inventory to change block type, then click to **place**!
                            </p>
                            
                            <!-- Game Canvas -->
                            <canvas id="game-canvas" class="w-full max-w-full aspect-square mx-auto"></canvas>

                            <!-- Inventory and Instructions -->
                            <div class="mt-4 flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4">
                                <div class="flex items-center space-x-2 p-2 bg-bg-light rounded-full shadow-inner">
                                    <span class="font-bold text-md text-magic-purple">Current:</span>
                                    <canvas id="inventory-canvas" width="40" height="40" class="border-4 border-sparkle-pink rounded-lg cursor-pointer"></canvas>
                                </div>
                                <button id="reset-game-button" class="bg-sparkle-pink text-white font-bold py-2 px-6 rounded-full hover:bg-pink-600 transition shadow-md text-sm">
                                    Reset World <i class="ph ph-arrow-counter-clockwise ml-1"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Game 2: Magic Number Guess -->
                        <div class="bg-white p-6 md:p-8 rounded-3xl card-shadow text-center flex flex-col justify-between">
                            <h2 class="text-2xl font-bold text-sky-blue mb-4">Game 2: Magic Number Guess</h2>
                            <p class="text-gray-600 mb-4 text-sm">
                                I'm thinking of a magic number between 1 and 100. Guess it!
                            </p>
                            
                            <div class="space-y-4">
                                <input type="number" id="guess-input" placeholder="Enter your guess (1-100)"
                                    class="w-full p-3 border-2 border-leaf-green rounded-xl focus:outline-none focus:ring-2 focus:ring-sparkle-pink text-center font-semibold"
                                >
                                <button id="guess-button"
                                    class="w-full py-3 bg-leaf-green text-white font-extrabold text-lg rounded-full transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg active:bg-green-600"
                                >
                                    Guess <i class="ph ph-magic-wand text-xl ml-1"></i>
                                </button>
                                <p id="guess-result" class="text-xl font-bold min-h-[50px] flex items-center justify-center text-magic-purple">
                                    Start guessing!
                                </p>
                                <button id="new-game-button"
                                    class="w-full py-2 bg-gray-300 text-gray-700 font-bold rounded-full hover:bg-gray-400 transition shadow-md text-sm"
                                >
                                    New Magic Number
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Row 2: Flappy Dog Adventure -->
                    <div class="bg-white p-6 md:p-8 rounded-3xl card-shadow text-center">
                        <h2 class="text-2xl font-bold text-sparkle-pink mb-4">Game 3: Flappy Dog Adventure</h2>
                        <p class="text-gray-600 mb-4 text-sm">
                            **Click/Tap** to make the dog fly! Avoid the magical bone pillars!
                        </p>
                        <!-- Flappy Dog Canvas -->
                        <canvas id="flappy-dog-canvas" class="w-full max-w-xl aspect-[4/3] mx-auto" style="border: 4px solid #EC4899; border-radius: 12px; touch-action: none; background-color: #79CCFF;"></canvas>
                        <div class="mt-4 flex justify-center space-x-4 flex-wrap">
                            <p id="flappy-score-display" class="font-bold text-xl text-magic-purple p-2">Score: 0</p>
                            <button id="flappy-start-button" class="bg-sparkle-pink text-white font-bold py-2 px-6 rounded-full hover:bg-pink-600 transition shadow-md text-sm">
                                Start/Restart <i class="ph ph-paw-print ml-1"></i>
                            </button>
                        </div>
                        <p id="flappy-status" class="text-sm mt-2 text-red-500 font-semibold"></p>
                    </div>

                </section>
                
                <!-- 3. MAGIC STUDIO SECTION (Camera Snap + AI Book) -->
                <section id="section-studio" class="page-section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        
                        <!-- Left Panel: Camera Snap -->
                        <div class="bg-white p-6 md:p-8 rounded-3xl card-shadow text-center">
                            <h2 class="text-2xl font-bold text-sparkle-pink mb-4">Camera Snap Tool</h2>
                            <p class="text-gray-600 mb-4 text-sm">
                                Take a picture of yourself or your pet! (Requires camera permission).
                            </p>
                            
                            <!-- Camera Feed -->
                            <video id="camera-feed" autoplay playsinline></video>
                            <canvas id="camera-canvas" class="hidden"></canvas>
                            
                            <!-- Snap Button and Error Message -->
                            <div class="mt-4 space-y-2">
                                <button id="snap-button"
                                    class="w-full py-3 bg-magic-purple text-white font-extrabold text-lg rounded-full transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg active:bg-violet-600 disabled:opacity-50"
                                    disabled
                                >
                                    Take Magic Snap! <i class="ph ph-camera text-xl ml-1"></i>
                                </button>
                                <p id="camera-error" class="text-red-500 text-sm hidden">
                                    Camera access denied or device not found.
                                </p>
                            </div>

                            <!-- Captured Image Display -->
                            <div class="mt-6 border-4 border-dashed border-gray-300 rounded-xl p-2 min-h-[100px] flex items-center justify-center">
                                <img id="captured-image" class="w-full max-w-xs rounded-lg hidden shadow-xl" alt="Captured Image">
                                <p id="snap-placeholder" class="text-gray-400 font-semibold">
                                    Your magic snap will appear here!
                                </p>
                            </div>
                        </div>

                        <!-- Right Panel: Anthro AI Book Generator 2000 -->
                        <div class="bg-white p-6 md:p-8 rounded-3xl card-shadow flex flex-col">
                            <h2 class="text-2xl font-bold text-leaf-green mb-4">Anthro AI Book Generator 2000</h2>
                            <p class="text-gray-600 mb-4 text-sm">
                                Write a short story about a magical dog!
                            </p>

                            <div class="space-y-3 mb-4">
                                <input type="text" id="anthro-name-input" placeholder="Anthro Dog's Name (e.g., Captain Fluff)"
                                    class="w-full p-3 border-2 border-leaf-green rounded-xl focus:outline-none focus:ring-2 focus:ring-sparkle-pink text-gray-700"
                                >
                                <textarea id="anthro-theme-input" rows="2" placeholder="Describe the dog's theme/adventure (e.g., flying to the moon to collect star-bones)"
                                    class="w-full p-3 border-2 border-leaf-green rounded-xl focus:outline-none focus:ring-2 focus:ring-sparkle-pink text-gray-700 resize-none"
                                ></textarea>
                                
                                <button id="generate-book-button"
                                    class="w-full py-3 bg-sparkle-pink text-white font-extrabold text-lg rounded-full transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg active:bg-pink-600"
                                >
                                    Generate Book! <i class="ph ph-book-open text-xl ml-1"></i>
                                </button>
                            </div>
                            
                            <!-- Book Output Area -->
                            <div class="flex-grow p-4 bg-bg-light rounded-xl shadow-inner overflow-y-auto max-h-[400px]">
                                <p id="book-output" class="text-gray-700 text-left whitespace-pre-wrap">
                                    Enter a name and theme above to start writing your magical story!
                                </p>
                                <div id="book-loading" class="hidden text-center">
                                    <i class="ph ph-spinner-gap text-3xl animate-spin text-sparkle-pink"></i>
                                    <p class="text-gray-500 mt-2">Writing your adventure...</p>
                                </div>
                            </div>
                            <p id="book-error" class="text-red-500 text-sm mt-2 hidden"></p>
                        </div>
                    </div>
                </section>


                <!-- 4. SIMULATED SEARCH SECTION -->
                <section id="section-search" class="page-section hidden">
                    <div class="bg-white p-6 md:p-10 rounded-3xl card-shadow text-center">
                        <h2 class="text-3xl font-bold text-sparkle-pink mb-4">Magic Link Search!</h2>
                        <p class="text-gray-600 mb-8">
                            Since I can't talk to a live server, I'll open your query in Google Search in a new tab!
                        </p>

                        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                             <input type="text" id="search-input" placeholder="What do you want to find? (e.g., 'best dog parks')"
                                class="flex-grow p-3 border-2 border-sparkle-pink rounded-full focus:outline-none focus:ring-2 focus:ring-magic-purple text-gray-700"
                                onkeydown="if(event.key === 'Enter') document.getElementById('search-button').click()"
                            >
                            <button id="search-button" onclick="performGoogleSearch()"
                                class="bg-magic-purple text-white py-3 px-6 rounded-full font-bold transition-all hover:bg-sky-blue focus:outline-none focus:ring-4 focus:ring-magic-purple focus:ring-opacity-50"
                            >
                                Search <i class="ph ph-magnifying-glass text-xl ml-1"></i>
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- 5. PRIVATE SMS DRAFT SECTION -->
                <section id="section-sms" class="page-section hidden">
                    <div class="bg-white p-6 md:p-10 rounded-3xl card-shadow text-center">
                        <h2 class="text-3xl font-bold text-leaf-green mb-4">Private SMS Draft Tool</h2>
                        <p class="text-gray-600 mb-6">
                            Enter the number and message, then click the button to **open your phone's native texting app** with the draft ready.
                        </p>

                        <div class="space-y-4 max-w-lg mx-auto">
                            <input type="tel" id="sms-number-input" placeholder="Enter recipient phone number (e.g., 5551234567)"
                                class="w-full p-3 border-2 border-leaf-green rounded-xl focus:outline-none focus:ring-2 focus:ring-sparkle-pink text-gray-700"
                            >
                            <textarea id="sms-message-input" rows="3" placeholder="Enter your magic message here..."
                                class="w-full p-3 border-2 border-leaf-green rounded-xl focus:outline-none focus:ring-2 focus:ring-sparkle-pink text-gray-700 resize-none"
                            ></textarea>
                            
                            <a id="sms-link-button" href="#" 
                                onclick="generateSmsDraft(event)"
                                class="block w-full py-3 bg-magic-purple text-white font-extrabold text-lg rounded-full transition-all duration-200 transform hover:scale-[1.02] hover:shadow-lg active:bg-violet-600"
                            >
                                Draft Message <i class="ph ph-chat-text text-xl ml-1"></i>
                            </a>
                        </div>
                        <p id="sms-error" class="text-red-500 text-sm mt-4 hidden">Please fill out both fields!</p>
                        <p class="text-gray-500 text-xs mt-4 italic">
                            (Note: This requires a mobile phone or a device with SMS capabilities to function.)
                        </p>
                    </div>
                </section>


                <!-- 6. RULE-BASED ASSISTANT SECTION -->
                <section id="section-chat" class="page-section hidden">
                    <div class="bg-white p-6 md:p-8 rounded-3xl card-shadow flex flex-col h-[70vh] max-h-[700px]">
                        <h2 class="text-3xl font-bold text-magic-purple mb-4 text-center">Ask The Magic Dog Assistant!</h2>
                        
                        <!-- Chat Window -->
                        <div id="chat-window" class="flex-grow overflow-y-auto p-3 bg-bg-light rounded-xl mb-4 space-y-4">
                            <!-- Initial Greeting -->
                            <div class="flex justify-start">
                                <div class="ai-message max-w-[80%] p-3 rounded-xl shadow-md text-gray-700">
                                    <span class="font-extrabold text-white">Woof! I'm Sparkle, your rule-based Dog Assistant! I know facts, games, and my own name! What's up? üêæ</span>
                                </div>
                            </div>
                            <!-- Messages will be added here -->
                        </div>

                        <!-- Chat Input -->
                        <div class="flex space-x-2">
                            <input type="text" id="chat-input" placeholder="Type your question here..."
                                class="flex-grow p-3 border-2 border-magic-purple rounded-full focus:outline-none focus:ring-2 focus:ring-sparkle-pink text-gray-700"
                                onkeydown="if(event.key === 'Enter') document.getElementById('chat-send-button').click()"
                            >
                            <button id="chat-send-button" onclick="handleChatSend()"
                                class="bg-magic-purple text-white w-12 h-12 rounded-full flex items-center justify-center transition-all hover:bg-sparkle-pink focus:outline-none focus:ring-4 focus:ring-magic-purple focus:ring-opacity-50"
                            >
                                <i id="chat-icon" class="ph ph-paper-plane-tilt text-2xl"></i>
                                <i id="loading-spinner" class="ph ph-spinner-gap text-2xl animate-spin hidden"></i>
                            </button>
                        </div>
                        <div id="chat-error" class="text-red-500 text-sm mt-2 hidden"></div>
                    </div>
                </section>

                <!-- 7. VIDEO SECTION -->
                <section id="section-videos" class="page-section hidden">
                    <div class="bg-white p-6 md:p-8 rounded-3xl card-shadow text-center">
                        <h2 class="text-3xl font-bold text-sky-blue mb-6">Pawsome Dog Videos!</h2>
                        <p class="text-gray-600 mb-8">
                            Watch these fun, kid-friendly dog adventures!
                        </p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            
                            <!-- Video 1: Cute Puppies -->
                            <div class="rounded-xl overflow-hidden shadow-lg bg-bg-light">
                                <iframe class="w-full aspect-video" src="https://www.youtube.com/embed/FwFjH9G65i4?si=k-F_oXl2mF5r4y0u" title="Cute Puppies" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                <div class="p-3">
                                    <h4 class="font-bold text-lg text-magic-purple">The Cutest Dog Compilation!</h4>
                                </div>
                            </div>

                            <!-- Video 2: Dog Tricks -->
                            <div class="rounded-xl overflow-hidden shadow-lg bg-bg-light">
                                <iframe class="w-full aspect-video" src="https://www.youtube.com/embed/fD3IinJg_9U?si=2T9Zk_Q9O-y1fK_c" title="Dog Training" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                <div class="p-3">
                                    <h4 class="font-bold text-lg text-magic-purple">Amazing Doggy Tricks!</h4>
                                </div>
                            </div>
                            
                            <!-- Video 3: Dog Adventures -->
                            <div class="rounded-xl overflow-hidden shadow-lg bg-bg-light">
                                <iframe class="w-full aspect-video" src="https://www.youtube.com/embed/K9552I3J6hA?si=lqR5hY6N8NlE-K7v" title="Funny Dogs" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                <div class="p-3">
                                    <h4 class="font-bold text-lg text-magic-purple">Silly Puppy Playtime!</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>
        
        <!-- Simple Footer -->
        <footer class="text-center p-4 text-sm text-gray-500 bg-white shadow-inner mt-auto">
            &copy; 2025 Magic Dogs Adventure Hub | All rights reserved.
        </footer>
    </div>

    <script>
        // Global constant for API Key (Canvas environment handles this)
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // =========================================================================
        // 1. NAVIGATION LOGIC
        // =========================================================================
        let currentPage = 'facts';
        
        /**
         * Switches the active section based on the provided section ID.
         * @param {string} pageId - The ID of the page section to show (e.g., 'facts', 'games', 'search').
         */
        function navigate(pageId) {
            currentPage = pageId;
            const sections = document.querySelectorAll('.page-section');
            const navButtons = document.querySelectorAll('.nav-button');

            sections.forEach(section => {
                section.classList.add('hidden');
            });
            
            navButtons.forEach(button => {
                button.classList.remove('active');
            });

            const activeSection = document.getElementById(`section-${pageId}`);
            const activeButton = document.getElementById(`nav-${pageId}`);
            
            if (activeSection) {
                activeSection.classList.remove('hidden');
            }
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // Special initialization for sections
            if (pageId === 'games') {
                initGames();
            } else if (pageId === 'studio') {
                startCameraFeed();
            } else {
                stopCameraFeed(); // Turn off camera when navigating away
            }
        }
        
        // =========================================================================
        // 2. CAMERA SNAP TOOL LOGIC (Studio Feature)
        // =========================================================================
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('camera-canvas');
        const snapButton = document.getElementById('snap-button');
        const capturedImage = document.getElementById('captured-image');
        const snapPlaceholder = document.getElementById('snap-placeholder');
        const cameraError = document.getElementById('camera-error');
        let stream = null;

        /** Starts the camera feed and enables the snap button. */
        function startCameraFeed() {
            cameraError.classList.add('hidden');
            if (stream) return; // Already running

            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(mediaStream => {
                    stream = mediaStream;
                    video.srcObject = mediaStream;
                    video.play();
                    snapButton.disabled = false;
                })
                .catch(err => {
                    console.error("Error accessing camera: ", err);
                    cameraError.classList.remove('hidden');
                    snapButton.disabled = true;
                });
        }
        
        /** Stops the camera feed by stopping all tracks. */
        function stopCameraFeed() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                video.srcObject = null;
                snapButton.disabled = true;
            }
        }

        /** Captures a frame from the video stream to the canvas and displays it. */
        function takePicture() {
            if (!stream) return;

            // Set canvas dimensions to match video stream
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Draw the video frame onto the canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas content to image data URL
            const imageDataURL = canvas.toDataURL('image/png');
            
            // Display the captured image
            capturedImage.src = imageDataURL;
            capturedImage.classList.remove('hidden');
            snapPlaceholder.classList.add('hidden');
        }
        
        snapButton.addEventListener('click', takePicture);

        // =========================================================================
        // 3. AI BOOK GENERATOR LOGIC (Studio Feature)
        // =========================================================================
        const nameInput = document.getElementById('anthro-name-input');
        const themeInput = document.getElementById('anthro-theme-input');
        const generateButton = document.getElementById('generate-book-button');
        const bookOutput = document.getElementById('book-output');
        const bookLoading = document.getElementById('book-loading');
        const bookError = document.getElementById('book-error');

        async function generateAIBook() {
            const name = nameInput.value.trim();
            const theme = themeInput.value.trim();

            if (!name || !theme) {
                bookError.textContent = "Please provide both a name and a theme!";
                bookError.classList.remove('hidden');
                setTimeout(() => bookError.classList.add('hidden'), 3000);
                return;
            }

            // Set loading state
            generateButton.disabled = true;
            bookOutput.classList.add('hidden');
            bookLoading.classList.remove('hidden');
            bookError.classList.add('hidden');
            
            const userQuery = `Write a short, engaging children's story about a magical anthropomorphic dog named ${name} who loves to ${theme}. The story should be 3 paragraphs long, with a clear beginning, middle, and end, suitable for reading aloud.`;
            const systemPrompt = "You are a professional children's book author. Write a creative, positive, and simple story about an anthropomorphic dog character based on the user's input. Do not include a title or chapter headings. Just the story text.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            const maxRetries = 3;
            let attempt = 0;
            let response = null;

            while (attempt < maxRetries) {
                try {
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    } else if (response.status === 429 && attempt < maxRetries - 1) {
                        // Rate limit error, continue to retry
                        attempt++;
                    } else {
                        throw new Error(`API returned status ${response.status}`);
                    }
                } catch (error) {
                    if (attempt < maxRetries - 1) {
                         attempt++;
                    } else {
                        // All retries failed
                        console.error('Gemini API call failed after multiple retries:', error);
                        bookError.textContent = 'Sorry, the magic ink ran out! Failed to connect to the story generator.';
                        bookError.classList.remove('hidden');
                        
                        // Exit loop and stop execution
                        attempt = maxRetries;
                    }
                }
            }
            
            // Handle final response or error
            generateButton.disabled = false;
            bookLoading.classList.add('hidden');

            if (response && response.ok) {
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    bookOutput.textContent = text;
                    bookOutput.classList.remove('hidden');
                } else {
                    bookOutput.textContent = 'The AI generated an empty scroll. Try a different theme!';
                    bookOutput.classList.remove('hidden');
                }
            } else if (attempt === maxRetries) {
                 // Error already set in the catch block
            } else {
                 bookError.textContent = 'An unexpected error occurred while generating the book.';
                 bookError.classList.remove('hidden');
            }
        }

        generateButton.addEventListener('click', generateAIBook);


        // =========================================================================
        // 4. GAMES LOGIC
        // =========================================================================
        
        // --- Fun Facts Logic ---
        const dogFacts = [
            "A dog's nose print is unique, just like a human's fingerprint!",
            "Dogs can be trained to detect cancer in humans.",
            "The fastest dog, the Greyhound, can run up to 45 miles per hour.",
            "Puppies are born blind and deaf.",
            "Banjos, a type of puppy, are magical creatures with tiny wings, though they only fly at night.",
            "The 'Magic Dog' breed can learn 100 words by the age of two.",
            "A dog's sense of smell is 10,000 to 100,000 times better than ours.",
            "The Basenji is the only dog that doesn't bark; it makes a yodel-like sound.",
        ];
        const factDisplay = document.getElementById('fact-display');
        const factButton = document.getElementById('fact-button');
        let lastFactIndex = -1;
        function displayRandomFact() {
            let newFactIndex;
            do {
                newFactIndex = Math.floor(Math.random() * dogFacts.length);
            } while (newFactIndex === lastFactIndex && dogFacts.length > 1);
            const fact = dogFacts[newFactIndex];
            lastFactIndex = newFactIndex;
            factDisplay.style.opacity = '0';
            factButton.disabled = true;
            setTimeout(() => {
                factDisplay.textContent = fact;
                factDisplay.style.opacity = '1';
                factButton.disabled = false;
            }, 300); 
        }
        factButton.addEventListener('click', displayRandomFact);

        // --- Game 1: Block World ---
        const gameCanvas = document.getElementById('game-canvas');
        const inventoryCanvas = document.getElementById('inventory-canvas');
        const resetGameButton = document.getElementById('reset-game-button');
        const ctx = gameCanvas.getContext('2d');
        const inventoryCtx = inventoryCanvas.getContext('2d');
        let TILE_SIZE = 40; 
        const BLOCK_TYPES = { AIR: 0, GRASS: 1, DIRT: 2, WOOD: 3, WATER: 4, STONE: 5, };
        const BLOCK_COLORS = { 
            [BLOCK_TYPES.AIR]: 'rgba(0,0,0,0)', [BLOCK_TYPES.GRASS]: '#38A169', 
            [BLOCK_TYPES.DIRT]: '#8B4513', [BLOCK_TYPES.WOOD]: '#A0522D', 
            [BLOCK_TYPES.WATER]: '#4FB4DE', [BLOCK_TYPES.STONE]: '#A9A9A9', 
        };
        let grid = [];
        let rows = 10;
        let cols = 10;
        let selectedBlock = BLOCK_TYPES.GRASS;
        function initializeGrid() {
            cols = Math.floor(gameCanvas.width / TILE_SIZE);
            rows = Math.floor(gameCanvas.height / TILE_SIZE);
            if (cols === 0 || rows === 0) return;
            grid = [];
            for (let r = 0; r < rows; r++) {
                grid[r] = [];
                for (let c = 0; c < cols; c++) {
                    if (r > rows - 2) {
                        grid[r][c] = BLOCK_TYPES.DIRT;
                    } else if (r === rows - 2) {
                        grid[r][c] = BLOCK_TYPES.GRASS;
                    } else {
                        grid[r][c] = BLOCK_TYPES.AIR;
                    }
                }
            }
            if (cols >= 4 && rows >= 4) {
                grid[rows - 3][1] = BLOCK_TYPES.WOOD; 
                grid[rows - 4][1] = BLOCK_TYPES.WOOD;
                grid[rows - 5][0] = BLOCK_TYPES.GRASS; 
                grid[rows - 5][1] = BLOCK_TYPES.GRASS; 
                grid[rows - 5][2] = BLOCK_TYPES.GRASS;
            }
            drawGame();
        }
        function drawGame() {
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const blockType = grid[r][c];
                    if (blockType !== BLOCK_TYPES.AIR) {
                        ctx.fillStyle = BLOCK_COLORS[blockType];
                        ctx.fillRect(c * TILE_SIZE, r * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                        ctx.strokeRect(c * TILE_SIZE, r * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    }
                }
            }
        }
        function drawInventory() {
            inventoryCtx.clearRect(0, 0, 40, 40);
            inventoryCtx.fillStyle = BLOCK_COLORS[selectedBlock];
            inventoryCtx.fillRect(0, 0, 40, 40);
            inventoryCtx.strokeStyle = 'black';
            inventoryCtx.strokeRect(0, 0, 40, 40);
        }
        function handleGameClick(x, y) {
            const col = Math.floor(x / TILE_SIZE);
            const row = Math.floor(y / TILE_SIZE);
            if (row >= 0 && row < rows && col >= 0 && col < cols) {
                const currentBlock = grid[row][col];
                if (currentBlock !== BLOCK_TYPES.AIR) {
                    grid[row][col] = BLOCK_TYPES.AIR;
                } else {
                    grid[row][col] = selectedBlock;
                }
                drawGame();
            }
        }
        function handleInventoryClick() {
            const availableBlocks = [BLOCK_TYPES.GRASS, BLOCK_TYPES.DIRT, BLOCK_TYPES.WOOD, BLOCK_TYPES.STONE, BLOCK_TYPES.WATER];
            let currentIndex = availableBlocks.indexOf(selectedBlock);
            currentIndex = (currentIndex + 1) % availableBlocks.length;
            selectedBlock = availableBlocks[currentIndex];
            drawInventory();
        }
        function resizeCanvas() {
            const containerWidth = gameCanvas.parentElement.offsetWidth;
            const newSize = Math.min(containerWidth, 500); 
            gameCanvas.width = newSize;
            gameCanvas.height = newSize;
            const newTileSize = Math.floor(newSize / 10);
            if (newTileSize > 0) {
                TILE_SIZE = newTileSize;
                initializeGrid();
            }
        }
        gameCanvas.addEventListener('click', (e) => {
            const rect = gameCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            handleGameClick(x, y);
        });
        gameCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); 
            const rect = gameCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            handleGameClick(x, y);
        });
        inventoryCanvas.addEventListener('click', handleInventoryClick);
        resetGameButton.addEventListener('click', initializeGrid);

        // --- Game 2: Number Guess ---
        const guessInput = document.getElementById('guess-input');
        const guessButton = document.getElementById('guess-button');
        const guessResult = document.getElementById('guess-result');
        const newGameButton = document.getElementById('new-game-button');
        let secretNumber;
        let attempts = 0;
        function startNewGuessingGame() {
            secretNumber = Math.floor(Math.random() * 100) + 1; // Number between 1 and 100
            attempts = 0;
            guessResult.textContent = "I've chosen a new number! Start guessing!";
            guessResult.classList.remove('text-leaf-green', 'text-sparkle-pink');
            guessResult.classList.add('text-magic-purple');
            guessInput.value = '';
            guessInput.disabled = false;
            guessButton.disabled = false;
        }
        function handleGuess() {
            const guess = parseInt(guessInput.value);
            if (isNaN(guess) || guess < 1 || guess > 100) {
                guessResult.textContent = "Woof! Please enter a valid number between 1 and 100.";
                guessResult.classList.remove('text-leaf-green', 'text-sparkle-pink');
                guessResult.classList.add('text-magic-purple');
                return;
            }
            attempts++;
            if (guess === secretNumber) {
                guessResult.textContent = `Pawsome! You guessed the magic number ${secretNumber} in ${attempts} tries! ‚ú®`;
                guessResult.classList.remove('text-magic-purple', 'text-sparkle-pink');
                guessResult.classList.add('text-leaf-green');
                guessInput.disabled = true;
                guessButton.disabled = true;
            } else if (guess < secretNumber) {
                guessResult.textContent = `Too low! Go higher, my friend. (Attempt: ${attempts})`;
                guessResult.classList.remove('text-leaf-green');
                guessResult.classList.add('text-sparkle-pink');
            } else {
                guessResult.textContent = `Too high! Try a bit lower. (Attempt: ${attempts})`;
                guessResult.classList.remove('text-leaf-green');
                guessResult.classList.add('text-sparkle-pink');
            }
            guessInput.value = '';
            guessInput.focus();
        }
        guessButton.addEventListener('click', handleGuess);
        newGameButton.addEventListener('click', startNewGuessingGame);
        guessInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleGuess();
        });

        // --- Game 3: Flappy Dog Adventure ---
        const flappyCanvas = document.getElementById('flappy-dog-canvas');
        const flappyCtx = flappyCanvas.getContext('2d');
        const flappyStartButton = document.getElementById('flappy-start-button');
        const flappyScoreDisplay = document.getElementById('flappy-score-display');
        const flappyStatus = document.getElementById('flappy-status');

        // Game constants
        const GRAVITY = 0.5;
        const JUMP_LIFT = -10;
        const PIPE_SPEED = 3;
        const PIPE_GAP = 150;
        const PIPE_WIDTH = 50;

        // Game state
        let flappyGameLoop;
        let isFlappyGameOver = true;
        let flappyScore = 0;
        let dog = {};
        let pipes = [];

        // Dog representation
        const DOG_SIZE = 30; // Font size for emoji
        const DOG_Y_OFFSET = DOG_SIZE / 2; // Approximate center of the dog emoji

        function resetFlappyDog() {
            // Resize canvas to fit container width, maintaining a 4:3 aspect ratio
            const containerWidth = flappyCanvas.parentElement.offsetWidth;
            const maxWidth = Math.min(containerWidth, 600); 
            flappyCanvas.width = maxWidth;
            flappyCanvas.height = maxWidth * 0.75; 
            
            dog = {
                x: 50,
                y: flappyCanvas.height / 2,
                velocity: 0,
                width: DOG_SIZE * 0.8,
                height: DOG_SIZE * 0.8,
            };
            
            pipes = [];
            flappyScore = 0;
            isFlappyGameOver = false;
            flappyScoreDisplay.textContent = `Score: 0`;
            flappyStatus.textContent = "Click or tap the screen to fly!";
            flappyStatus.classList.remove('text-red-500');
            flappyStatus.classList.add('text-magic-purple');

            // Clear any previous animation frame
            if (flappyGameLoop) cancelAnimationFrame(flappyGameLoop);
            
            // Draw the initial state
            drawFlappyDog();
        }

        function addPipe() {
            // Ensure pipe height leaves room for the gap and min/max boundaries
            const minPipeHeight = 50;
            const maxPipeHeight = flappyCanvas.height - PIPE_GAP - minPipeHeight;
            const pipeHeight = Math.floor(Math.random() * (maxPipeHeight - minPipeHeight + 1) + minPipeHeight);

            pipes.push({
                x: flappyCanvas.width,
                y: 0, // Top pipe starts at top
                width: PIPE_WIDTH,
                height: pipeHeight, // Height of the top pipe
                bottomY: pipeHeight + PIPE_GAP, // Y position where the bottom pipe starts
                passed: false
            });
        }

        function drawDog() {
            flappyCtx.font = `${DOG_SIZE}px sans-serif`;
            flappyCtx.textAlign = 'center';
            flappyCtx.textBaseline = 'middle';
            flappyCtx.save();
            
            // Simple rotation for visual effect based on velocity
            const maxAngle = Math.PI / 4;
            const rotation = Math.min(Math.max(dog.velocity * 0.05, -maxAngle), maxAngle);
            
            // Translate to the center of the dog for rotation
            flappyCtx.translate(dog.x + dog.width / 2, dog.y + dog.height / 2);
            flappyCtx.rotate(rotation);
            flappyCtx.fillText('üê∂', 0, 0); 
            flappyCtx.restore();
        }

        function drawPipes() {
            flappyCtx.fillStyle = '#10B981'; // Leaf-green for pipes
            pipes.forEach(pipe => {
                // Draw Top Pipe (Bone Pillar)
                flappyCtx.fillRect(pipe.x, pipe.y, pipe.width, pipe.height);
                
                // Draw Bottom Pipe (Bone Pillar)
                const bottomHeight = flappyCanvas.height - pipe.bottomY;
                flappyCtx.fillRect(pipe.x, pipe.bottomY, pipe.width, bottomHeight);

                // Simple bone tip effect (light gray rectangles)
                flappyCtx.fillStyle = '#D1D5DB'; // Gray-300
                flappyCtx.fillRect(pipe.x, pipe.height - 10, pipe.width, 10);
                flappyCtx.fillRect(pipe.x, pipe.bottomY, pipe.width, 10);
                flappyCtx.fillStyle = '#10B981'; // Reset color
            });
        }

        function updateGame() {
            // 1. Dog Physics (Apply Gravity and Update Position)
            dog.velocity += GRAVITY;
            dog.y += dog.velocity;

            // 2. Pipe Movement and Generation
            pipes.forEach(pipe => {
                pipe.x -= PIPE_SPEED;
                
                // Check for passing a pipe and scoring
                if (pipe.x + pipe.width < dog.x && !pipe.passed) {
                    pipe.passed = true;
                    flappyScore++;
                    flappyScoreDisplay.textContent = `Score: ${flappyScore}`;
                }
            });

            // Remove off-screen pipes
            pipes = pipes.filter(pipe => pipe.x + PIPE_WIDTH > 0);

            // Add new pipe periodically 
            if (pipes.length === 0 || pipes[pipes.length - 1].x < flappyCanvas.width - 250) {
                addPipe();
            }

            // 3. Collision Detection
            
            // Ground/Ceiling Collision
            // Dog uses its approximate center point (y) for drawing, so we use offset for bounds
            const dogTop = dog.y - DOG_Y_OFFSET;
            const dogBottom = dog.y + DOG_Y_OFFSET;

            if (dogBottom > flappyCanvas.height - 5 || dogTop < 0) { // -5 is for the ground line
                endFlappyGame("Ouch! Hit the ground or the sky!");
                return;
            }
            
            // Pipe Collision
            for (const pipe of pipes) {
                const pipeTopCollision = dogTop < pipe.height;
                const pipeBottomCollision = dogBottom > pipe.bottomY;

                if (
                    dog.x + dog.width > pipe.x && 
                    dog.x < pipe.x + pipe.width &&
                    (pipeTopCollision || pipeBottomCollision)
                ) {
                    endFlappyGame("Oh no! Hit a magical bone pillar!");
                    return;
                }
            }
        }

        function endFlappyGame(message) {
            isFlappyGameOver = true;
            cancelAnimationFrame(flappyGameLoop);
            flappyStatus.textContent = `${message} Final Score: ${flappyScore}. Tap Restart!`;
            flappyStatus.classList.remove('text-magic-purple');
            flappyStatus.classList.add('text-red-500');
            // Draw final screen state
            drawFlappyDog(); 
        }

        function flappyJump(e) {
            if (isFlappyGameOver) return;
            
            // Prevent accidental scrolling on touch devices
            if (e.type === 'touchstart') e.preventDefault();
            
            dog.velocity = JUMP_LIFT;
        }

        function drawFlappyDog() {
            // Clear the canvas and set background (sky blue)
            flappyCtx.clearRect(0, 0, flappyCanvas.width, flappyCanvas.height);
            flappyCtx.fillStyle = flappyCanvas.style.backgroundColor; // Use the blue color from style
            flappyCtx.fillRect(0, 0, flappyCanvas.width, flappyCanvas.height);
            
            // Draw pipes first
            drawPipes();
            
            // Draw dog
            drawDog();
            
            // Draw ground (a grass patch)
            flappyCtx.fillStyle = '#38A169'; // Grass
            flappyCtx.fillRect(0, flappyCanvas.height - 5, flappyCanvas.width, 5); 
        }

        function flappyLoop() {
            if (!isFlappyGameOver) {
                updateGame();
                drawFlappyDog();
                flappyGameLoop = requestAnimationFrame(flappyLoop);
            }
        }

        function startGame() {
            if (isFlappyGameOver) {
                resetFlappyDog();
                flappyLoop();
            }
        }

        // Event Listeners for Flappy Dog
        flappyStartButton.addEventListener('click', startGame);
        flappyCanvas.addEventListener('click', flappyJump);
        flappyCanvas.addEventListener('touchstart', flappyJump);


        // =========================================================================
        // 5. GLOBAL INITIALIZATION
        // =========================================================================

        /** Initializes all games in the games section. */
        function initGames() {
            // Game 1: Block World setup
            resizeCanvas();
            drawInventory();

            // Game 2: Number Guess setup
            startNewGuessingGame();

            // Game 3: Flappy Dog setup
            resetFlappyDog(); 
        }

        window.addEventListener('resize', () => {
            // Only re-initialize games if we are on the games page for responsiveness
            if (currentPage === 'games') {
                // Cancel existing flappy loop before resizing and restarting
                if (flappyGameLoop) cancelAnimationFrame(flappyGameLoop); 
                initGames(); 
            }
        });
        
        window.onload = function() {
            navigate('facts');
            setTimeout(displayRandomFact, 500);
            
            // Set initial state for the AI Book output
            bookOutput.classList.remove('hidden');
            bookLoading.classList.add('hidden');
        }
        
    </script>
</body>
</html>
