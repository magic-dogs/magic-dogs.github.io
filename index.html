<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒŸ MAGIC DOGS ğŸ¶ - The BEST Christmas Site!</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Firebas Modules for Chat History -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, query, orderBy, limit, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // This is important for debugging Firestore!
        // setLogLevel('Debug'); // Uncomment this line if you need debug logs

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;
        // Global storage for the latest messages
        window.chatMessages = [];

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Handle Authentication
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    // Start listening to chat history once we have a user ID
                    setupChatListener();
                } else {
                    // Sign in anonymously if no token is available or user is logged out
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Sign-in failed:", error);
                    }
                }
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `My ID is: ${userId || 'Loading...'}`;
            });
        }

        // Global function to handle chat listening
        window.setupChatListener = function() {
            if (!db || !userId) return;

            const chatCollectionPath = `/artifacts/${appId}/users/${userId}/magic_dogs_chat`;
            const q = query(collection(db, chatCollectionPath), orderBy("timestamp", "asc"));

            onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push(doc.data());
                });
                window.chatMessages = messages; // Update the global message list
                window.renderChatHistory(messages); // Call the window function to update the UI
            }, (error) => {
                console.error("Error listening to chat history:", error);
            });
        }

        // Global function to save a message
        window.saveMessage = async function(role, text) {
            if (!db || !userId) {
                console.error("Firestore not ready or no user ID.");
                return;
            }

            const chatCollectionPath = `/artifacts/${appId}/users/${userId}/magic_dogs_chat`;
            
            // Create a new document with a unique ID
            await setDoc(doc(collection(db, chatCollectionPath)), {
                role: role,
                text: text,
                timestamp: serverTimestamp() // Use server timestamp for ordering
            });
        }
        
        // Expose DB for direct use in the send handler
        window.db = db;
        window.getUserId = () => userId;
        window.getAppId = () => appId;
    </script>

    <style>
        /* A fun, handwriting-style font for the 'kid-made' feel */
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');
        
        .kid-font {
            font-family: 'Permanent Marker', cursive, 'Comic Sans MS', sans-serif;
            text-shadow: 2px 2px 0 #000;
        }

        .chat-bubble-user {
            @apply bg-blue-300 text-gray-800 self-end;
            border-radius: 18px 18px 0 18px;
        }

        .chat-bubble-ai {
            @apply bg-red-400 text-white self-start;
            border-radius: 18px 18px 18px 0;
            text-shadow: 1px 1px 0 #000; /* Extra kid-friendly shadow */
        }
        
        .chat-container {
            /* Max height and overflow for the chat log */
            max-height: 400px;
            overflow-y: auto;
            border: 4px dashed #009900; /* Green dashed border */
            background-color: #F8F4E3; /* Light cream/paper background */
        }
    </style>
</head>
<body class="bg-pink-100 min-h-screen p-4 md:p-8 kid-font text-gray-800">
    
    <!-- Big Title Header -->
    <header class="text-center mb-8 p-4 bg-red-500 rounded-2xl shadow-xl border-4 border-yellow-400 transform rotate-2">
        <h1 class="text-4xl sm:text-6xl text-white tracking-widest leading-none">
            âœ¨ MAGIC DOGS! âœ¨
        </h1>
        <p class="text-lg sm:text-2xl text-yellow-200 mt-2 transform -rotate-2">
            This is the best christmas site with other cool stuff to vist!!!ğŸ„        </p>
        <div id="user-id-display" class="text-xs text-green-700 mt-2 font-normal">Loading user info...</div>
    </header>

    <!-- Main Content Grid -->
    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Videos & Games -->
        <div class="lg:col-span-2 space-y-8">

            <!-- Funny Dog Videos Section -->
            <section class="p-6 bg-green-500 rounded-xl shadow-lg border-4 border-white">
                <h2 class="text-3xl text-yellow-200 mb-4 text-center pb-2 border-b-4 border-yellow-400">
                    ğŸ¬ Funny Puppy Videos!
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-3 bg-white rounded-lg shadow-md border-2 border-red-500">
                        <h3 class="text-xl text-red-600 mb-2">Doggy Olympics!</h3>
                        <p class="text-sm">They try to catch the steak and run super fast!</p>
                        <a href="https://www.youtube.com/watch?v=mRHj9ZFXhK4" target="_blank" class="block mt-2 text-center py-2 bg-yellow-400 hover:bg-yellow-500 rounded-lg text-lg text-gray-800 font-bold shadow-md">
                            WATCH IT!
                        </a>
                    </div>
                    <div class="p-3 bg-white rounded-lg shadow-md border-2 border-red-500">
                        <h3 class="text-xl text-red-600 mb-2">Talking Corgi!</h3>
                        <p class="text-sm">This dog is so smart, he can almost talk like a human!</p>
                        <a href="https://www.youtube.com/watch?v=WSnnwIDgQyI" target="_blank" class="block mt-2 text-center py-2 bg-yellow-400 hover:bg-yellow-500 rounded-lg text-lg text-gray-800 font-bold shadow-md">
                            MUST SEE!
                        </a>
                    </div>
                </div>
            </section>

            <!-- Games Section -->
            <section class="p-6 bg-red-500 rounded-xl shadow-lg border-4 border-white">
                <h2 class="text-3xl text-yellow-200 mb-4 text-center pb-2 border-b-4 border-yellow-400">
                    ğŸ® Fun Game Links! 
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <!-- Game 1 -->
                    <a href="https://www.abcya.com" target="_blank" class="block text-center p-3 bg-white rounded-lg shadow-lg hover:bg-red-200 transform hover:scale-105 transition duration-300 border-2 border-green-600">
                        <span class="text-2xl">ğŸ“š</span>
                        <p class="text-sm font-bold text-gray-800">ABCya! Games</p>
                    </a>
                    <!-- Game 2 -->
                    <a href="https://pbskids.org/games" target="_blank" class="block text-center p-3 bg-white rounded-lg shadow-lg hover:bg-red-200 transform hover:scale-105 transition duration-300 border-2 border-green-600">
                        <span class="text-2xl">ğŸ“º</span>
                        <p class="text-sm font-bold text-gray-800">PBS Kids Fun!</p>
                    </a>
                    <!-- Game 3 -->
                    <a href="https://www.funbrain.com/" target="_blank" class="block text-center p-3 bg-white rounded-lg shadow-lg hover:bg-red-200 transform hover:scale-105 transition duration-300 border-2 border-green-600">
                        <span class="text-2xl">ğŸ§ </span>
                        <p class="text-sm font-bold text-gray-800">Funbrain Puzzles</p>
                    </a>
                </div>
            </section>
            
            <!-- Christmas Doggy Facts -->
            <section class="p-6 bg-yellow-300 rounded-xl shadow-lg border-4 border-red-500">
                <h2 class="text-3xl text-red-600 mb-4 text-center pb-2 border-b-4 border-red-500">
                    ğŸ¾ Christmas Doggy Safety Tips! ğŸ…
                </h2>
                <ul class="text-lg space-y-2 list-disc list-inside text-gray-800 px-4">
                    <li>ğŸš« Don't let your dog eat chocolate! It makes their tummy hurt super bad.</li>
                    <li>ğŸ¦´ Turkey bones can get stuck, so only give them special doggy treats!</li>
                    <li>ğŸ¡ Give your dog a quiet room to hide in if the Christmas party gets too loud!</li>
                    <li>ğŸ„ Keep tinsel and fake plants away from dogs because they might think it's food!</li>
                </ul>
            </section>
        </div>

        <!-- Right Column: Chatbot (Sparkle!) -->
        <div class="lg:col-span-1">
            <section class="p-6 bg-white rounded-xl shadow-2xl border-4 border-green-600">
                <h2 class="text-3xl text-green-700 mb-4 text-center transform -rotate-1">
                    âœ¨ Sparkle the Magic Dog! âœ¨
                </h2>
                <p class="text-sm text-center text-gray-600 mb-4 font-normal">Ask me anything about dogs, Christmas, or magic!</p>

                <!-- Chat Log -->
                <div id="chat-log" class="chat-container flex flex-col space-y-3 p-4 rounded-lg mb-4">
                    <!-- Chat messages will go here -->
                </div>

                <!-- TTS Button and Loading -->
                <div class="mb-4 flex flex-col space-y-2">
                    <button id="read-aloud-btn" 
                            class="p-3 bg-pink-500 text-white rounded-lg shadow-md hover:bg-pink-600 transition duration-300 active:bg-pink-700 font-bold text-lg transform -rotate-1">
                        Read Sparkle's Last Message! âœ¨ğŸ”Š
                    </button>
                    <div id="tts-loading" class="hidden text-center text-red-500">
                        <span class="animate-pulse">Sparkle is barking the message... ğŸ—£ï¸</span>
                    </div>
                </div>

                <!-- Loading Indicator for Chat -->
                <div id="loading-indicator" class="hidden text-center text-red-500 mb-4">
                    <span class="animate-pulse">Sparkle is thinking... ğŸ¶ğŸ§ </span>
                </div>

                <!-- Input Field -->
                <div class="flex space-x-2">
                    <input type="text" id="user-input" placeholder="Ask Sparkle a question..." 
                           class="flex-grow p-3 border-4 border-green-500 rounded-lg focus:outline-none focus:border-red-500 text-base">
                    <button id="send-btn" 
                            class="p-3 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 transition duration-300 active:bg-red-700 font-bold text-lg transform rotate-1">
                        SEND!
                    </button>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Hidden Audio Element for TTS -->
    <audio id="tts-audio" class="hidden"></audio>

    <script type="module">
        // --- CHATBOT CONSTANTS ---
        const API_KEY = ""; // API key will be provided by the runtime
        const CHAT_MODEL_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const TTS_MODEL_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;
        const CHATBOT_NAME = "Sparkle";
        
        // The kid-friendly persona for the AI
        const SYSTEM_PROMPT = `You are ${CHATBOT_NAME}, a friendly, very excited, and slightly chaotic magical Christmas puppy. You love dogs, glitter, and Christmas lights. You speak in a very enthusiastic, kid-friendly way, using lots of emojis like ğŸ„, âœ¨, and ğŸ¶. Keep answers short and fun, maybe 1-2 sentences. Always sign off with a "Woof-woof!".`;

        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const readAloudBtn = document.getElementById('read-aloud-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const ttsLoadingIndicator = document.getElementById('tts-loading');
        const ttsAudio = document.getElementById('tts-audio');

        // Function to render a single message bubble
        function appendMessage(role, text) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('max-w-[80%]', 'p-3', 'rounded-xl', 'shadow-md', 'text-sm');
            messageDiv.style.wordBreak = 'break-word';

            if (role === 'user') {
                messageDiv.classList.add('chat-bubble-user');
                messageDiv.textContent = text;
            } else {
                messageDiv.classList.add('chat-bubble-ai');
                messageDiv.textContent = `${CHATBOT_NAME}: ${text}`;
            }

            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        
        // Global function to render all messages from Firestore
        window.renderChatHistory = function(messages) {
            chatLog.innerHTML = ''; // Clear existing messages
            messages.forEach(msg => {
                appendMessage(msg.role, msg.text);
            });
            // Auto-scroll to the bottom after loading history
            chatLog.scrollTop = chatLog.scrollHeight;
        };
        
        // --- Gemini API Call with Exponential Backoff ---
        async function fetchWithBackoff(url, payload) {
            const maxRetries = 5;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    return response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Log to console if debugging needed, but suppress for user
                }
            }
        }

        // --- CHAT LOGIC ---
        async function fetchGeminiResponse(userQuery, history) {
            const contents = history.map(msg => ({ 
                role: msg.role === 'user' ? 'user' : 'model', 
                parts: [{ text: msg.text }] 
            }));
            
            contents.push({ role: 'user', parts: [{ text: userQuery }] });

            const payload = {
                contents: contents,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: SYSTEM_PROMPT }]
                },
                generationConfig: {
                    temperature: 0.8, 
                    maxOutputTokens: 100 
                }
            };
            
            const result = await fetchWithBackoff(CHAT_MODEL_URL, payload);

            const candidate = result.candidates?.[0];
            if (candidate && candidate.content?.parts?.[0]?.text) {
                return candidate.content.parts[0].text;
            }
            return "Uh oh! Sparkle can't find the magic words right now! Try again? ğŸ¥º";
        }
        
        // --- Main Send Logic ---
        async function handleSend() {
            const query = userInput.value.trim();
            if (!query || !window.saveMessage || !window.db) return;

            // 1. Disable input and show loading
            userInput.disabled = true;
            sendBtn.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                // 2. Save user message to Firestore
                await window.saveMessage('user', query);
                userInput.value = '';

                // 3. Get the AI response using the current history
                const aiText = await fetchGeminiResponse(query, window.chatMessages);

                // 4. Save AI response to Firestore
                await window.saveMessage('model', aiText);

            } catch (error) {
                console.error("Chat sending failed:", error);
            } finally {
                // 5. Re-enable input and hide loading
                userInput.disabled = false;
                sendBtn.disabled = false;
                loadingIndicator.classList.add('hidden');
                userInput.focus();
            }
        }
        
   
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM

            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);

    
            writeString(view, 0, 'RIFF'); // Chunk ID
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true); // Chunk Size
            writeString(view, 8, 'WAVE'); // Format

      
            writeString(view, 12, 'fmt '); // Sub-chunk 1 ID
            view.setUint32(16, 16, true); // Sub-chunk 1 Size (16 for PCM)
            view.setUint16(20, 1, true); // Audio Format (1 for PCM)
            view.setUint16(22, numChannels, true); // Num Channels
            view.setUint32(24, sampleRate, true); // Sample Rate
            view.setUint32(28, sampleRate * numChannels * bytesPerSample, true); // Byte Rate
            view.setUint16(32, numChannels * bytesPerSample, true); // Block Align
            view.setUint16(34, 16, true); // Bits Per Sample (16-bit)

            writeString(view, 36, 'data'); // Sub-chunk 2 ID
            view.setUint32(40, pcm16.length * bytesPerSample, true); // Sub-chunk 2 Size

     
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

     
        async function handleReadAloud() {
            readAloudBtn.disabled = true;
            ttsLoadingIndicator.classList.remove('hidden');
            
       
            const lastAiMessage = window.chatMessages.slice().reverse().find(msg => msg.role === 'model');
            
            if (!lastAiMessage) {
                alert("Sparkle hasn't said anything yet! Ask a question first! ğŸ¶");
                readAloudBtn.disabled = false;
                ttsLoadingIndicator.classList.add('hidden');
                return;
            }

            const textToSpeak = lastAiMessage.text;

          
            const payload = {
                contents: [{
                    parts: [{ text: `Say in a cheerful, excited, puppy dog voice: ${textToSpeak}` }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Puck" } // Upbeat voice
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
          
                const result = await fetchWithBackoff(TTS_MODEL_URL, payload);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);

            
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    ttsAudio.src = audioUrl;
                    ttsAudio.play();
                } else {
                    alert("Sparkle's voice magic didn't work! (No audio data received) ğŸ˜");
                }

            } catch (error) {
                console.error("TTS Error:", error);
                alert("Oh no! Sparkle got scared and couldn't talk! Try again? (Check console for error) ğŸ˜±");
            } finally {
                readAloudBtn.disabled = false;
                ttsLoadingIndicator.classList.add('hidden');
            }
        }

    
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSend();
            }
        });
        readAloudBtn.addEventListener('click', handleReadAloud);
        
       
        window.onload = function() {
            setTimeout(() => {
               
                if (window.chatMessages.length === 0) {
                    appendMessage('model', "Hooray! I'm Sparkle, a super cool Christmas dog! Ask me what my favorite treat is or about a magic dog trick! Woof-woof! ğŸ¶ğŸ„");
                }
            }, 1500);
        }
    </script>
</body>
</html>
